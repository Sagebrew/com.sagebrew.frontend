machine:
  services:
    - redis
    - docker
  python:
    version: 2.7.6

dependencies:
  pre:
    - pip install awscli
    - pip install boto
    - pip install unipath
  override:
    - npm install
  post:
    - bower install
    - npm install testem -g
    - npm install -g ember-cli

test:
  override:
    - echo 1
  post:
    - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < ~/com.sagebrew.frontend/dockercfg.template > ~/.dockercfg
    - ~/virtualenvs/venv-2.7.6/bin/python ~/com.sagebrew.frontend/dockerfiles/populate_docker.py
    - docker build -t sagebrew/sb_app:$CIRCLE_SHA1 ~/com.sagebrew.frontend/deployment/
    - docker build -t sagebrew/mass_sys:$CIRCLE_SHA1 ~/com.sagebrew.frontend/dockerfiles/
    - docker run --name redis-container -d redis
    - docker run --name ember_app --link redis-container:redis -e APP_NAME=emberapp -d -t sagebrew/sb_app:$CIRCLE_SHA1

deployment:
  production:
    branch: master
    commands:
      - bash -x ~/com.sagebrew.frontend/deployment/master.sh $CIRCLE_SHA1
  staging:
    branch: staging
    commands:
      - bash -x ~/com.sagebrew.frontend/deployment/staging.sh $CIRCLE_SHA1


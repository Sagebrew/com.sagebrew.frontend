machine:
  services:
    - redis
    - docker
  python:
    version: 2.7.6

dependencies:
  pre:
    - pip install awscli
    - pip install boto
  override:
    - npm install
  post:
    - bower install
    - npm install testem -g
    - npm install -g ember-cli

test:
  override:
    - echo 1
  post:
    - docker build -t sagebrew/sb_app:$CIRCLE_SHA  ~/com.sagebrew.frontend/deployment/
    - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < ~/com.sagebrew.frontend/dockercfg.template > ~/.dockercfg
    - sed "s/<BRANCH>/$CIRCLE_BRANCH/;s/<APP_USER>/$APP_USER/;s/<APP_USER>/$APP_USER/" < ~/com.sagebrew.frontend/dockerfiles/dockerfile.template > ~/com.sagebrew.frontend/dockerfiles/Dockerfile
    - docker build -t sagebrew/mass_sys:$CIRCLE_SHA1 ~/com.sagebrew.frontend/dockerfiles/
    - docker run --name redis-container -d redis
    - docker run --name ember_app --link redis-container:redis -e APP_NAME=emberapp -d -t sagebrew/sb_app:latest

deployment:
  production:
    branch: master
    commands:
      - ember deploy --environment production
  staging:
    branch: staging
    commands:
      - ember deploy --environment staging
      - bash -x ~/com.sagebrew.frontend/deployment/staging.sh $CIRCLE_SHA1